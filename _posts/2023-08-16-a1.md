---
layout: single
title:  "Node.js 백엔드 스터디(6) - JS에서 비동기 처리하기"
tag: [웹-Backend]
toc: true 

























---

### 연구 타겟

비동기 처리 방식의 3가지 방식에 대해 다뤄보겠다.

1. 콜백(callback): 요청이 끝난 후 실행할 함수를 매개변수로 추가하는 방식. 비동기 코드를 순서대로 실행하는 가장 일반적인 방식. 콜백은 함수의 파라미터로 함수를 전달하며, 비동기 처리가 끝났을 때 전달된 함수를 실행한다. 콜백은 가독성이 좋지 못하여 유지보수, 디버깅이 힘들다.
2. 프로미스(Prmoise): Promise 객체를 반환하는 방식. 콜백 대신 사용하며, Promise 객체는 처음에는 대기였다가 작업이 완료되면 성공 또는 실패 상태가 된다. then(), catch() 메서드를 사용하여 성공과 실패에 대한 처리를 할 수가 있다.
3. 어싱크 어웨이트(async await): 프로미스를 더욱 간단하게 async await 구문으로 변경하는 문법. 프로미스를 사용하는 비동기 작업을 동기적으로 처리하는 것처럼 코드를 작성할 수 있게 해준다. async가 붙어 있는 함수를 실행할 때 await 키워드를 사용하여 비동기 작업이 완료될 때까지 기다릴 수 있다.



### 1. 콜백 함수

아래 코드는 예상대로 함수의 실행 순서(register() → saveDB() → sendEmail() → getResult())가 보장됨을 볼 수 있다. 하지만, 콜백은 깊어지면 점점 알아보기 힘든 상황이 발생할 수 있다.

이러한 콜백의 문제를 해결할 목적으로 개발된 것이 '프로미스(Promise)\ 객체'이다.

```javascript
// chapter5 > callback-test.js

const DB = [];

// 회원 가입 API 함수
function register(user) { // 1. 콜백이 3중으로 중첩된 함수
    return saveDB(user, function (user) { // 콜백
        return sendEmail(user, function (user) { // 콜백
            return getResult(user); // 콜백
        });
    });
}

// 2. DB에 저장 후 콜백 실행
function saveDB(user, callback) {
    DB.push(user);
    console.log(`save ${user.name} to DB`);
    return callback(user);
}

// 3. 이메일 발송 로그만 남기는 코드 실행 후 콜백 실행
function sendEmail(user, callback) {
    console.log(`email to ${user.email}`);
    return callback(user);
}

// 4. 결과를 반환하는 함수
function getResult(user) {
    return `success register ${user.name}`;
}

const result = register({ email: "andy@test.com", password: "1234", name: "andy" });
console.log(result);
```

![image-20230816164904351](../../images/2023-08-16-a1/image-20230816164904351.png)









### 2. Promise 객체

Promise는 자바스크립트에서는 비동기 실행을 동기화하는 구문으로 사용한다.

Promise는 각각 이행, 거절, 대기 세 가지 상태를 가질 수 있으며, Promise는 개체이므로 new 연산자로 인스턴스를 생성할 수 있다.

Promise 객체가 생성되면 대기 상태가 된다. resolve() 함수가 실행되면 이행으로 변경되고 실패하면 reject() 함수가 실행되며 거절로 변경된다.

아래 코드는 위 콜백 함수(saveDB(), sendEmail(), getResult())를 Promise 객체로 변경한 코드이다.

```javascript
// chapter5 > promise-test.js

const { resolve } = require("path");

const DB = [];

function saveDB(user) {
    const oldDBSize = DB.length;
    DB.push(user);
    console.log(`save ${user.name} to DB`);
    return new Promise((resolve, reject) => { // 콜백 대신 Promise 객체 반환
        if (DB.length > oldDBSize) {
            resolve(user); // 성공 시 유저 정보 반환
        } else {
            reject(new Error("Save DB Error!")); // 1. 실패 시 에러 발생
        }
    });
}

function sendEmail(user) {
    console.log(`email to ${user.email}`);
    return new Promise((resolve) => {
        resolve(user); // Promise 객체를 반환. 실패 처리 없음
    })
}

function getResult(user) {
    return new Promise((resolve, reject) => { // Promise 객체 반환
        resolve(`success register ${user.name}`); // 성공 시 성공 메시지와 유저명 반환
    });
}

function registerByPromise(user) {
    // 2. 비동기 호출이지만, 순서를 지키며 실행
    const result = saveDB(user).then(sendEmail).then(getResult);
    // 3. 아직 완료되지 않았으므로 지연(pending) 상태
    console.log(result);
    return result;
}

const myUser = { email: "andy@test.com", password: "1234", name: "andy" };
const result = registerByPromise(myUser);
// 결괏값이 Promise이므로 then() 메서드에 함수를 넣어서 결괏값을 볼 수 있음
result.then(console.log);
```

![image-20230816170947394](../../images/2023-08-16-a1/image-20230816170947394.png)



아래와 같이 .then() 쓸 수 있는 이유는 user를 인수로 넣었을 때 반환되는 결과가 Promise이기 때문이다.

```javascript
const result = saveDB(user).then(sendEmail).then(getResult);
```



Promise 객체의 실행 결과로 실패를 주어야 하는 경우 reject() 함수를 사용한다. 그리고 Promise에서 발생한 에러는 .catch()를 사용한다. 

```
const result = saveDB(user).then(sendEmail).then(getResult).catch(error => new Error(error));
```





### 3. async await 구문

async와 await는 자바스크립트에 가장 최근 도입된 비동기 처리 방식이다. 기존의 비동기 처리 방식인 콜백 함수와 프로미스의 단점을 보완했으며 가독성 높은 코드를 작성할 수 있다.

**async는 함수 앞에 붙이는 키워드인데, async가 붙은 함수는 프로미스를 반환한다.**

#### 예제 1 - 단순 예제 async

async 키워드가 붙어있는 함수의 반환값을 출력하면, Promise 객체로 리턴하는 것을 확인할 수 있다.

```javascript
// async-await.js

async function myName() {
    return "Andy";
}

console.log(myName());
```

![image-20230816215241847](../../images/2023-08-16-a1/image-20230816215241847.png)





#### 예제 2 - 단순 예제 await

await은 Promise 객체의 실행이 완료되기를 기다린다. 그러므로 await의 뒤에는 Promise가 오게 된다. 

await은 Promise 객체인 myName() 함수의 실행이 끝나길 기다린다. 출력 결과에서 Promise  { <pending> }은 console.log(showName())의 결괏값이다. showName()도 async가 붙어있으니 Promise 이다.

showName()을 출력했을 때, PromiseResult: undefined인 이유는 return이 없어서이다.

```javascript
// async-await.js

async function myName() {
    return "Andy";
}

async function showName() {
    const name = await myName();
    console.log(`showName 함수: ${name}`);
}

console.log(showName());
```

![image-20230816221728441](../../images/2023-08-16-a1/image-20230816221728441.png)

